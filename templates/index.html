<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="AI ê¸°ë°˜ ì œí’ˆ ë¦¬ë·° ë¶„ì„ ì„œë¹„ìŠ¤ - ì‹¤ì‚¬ìš© í›„ê¸°ë¥¼ ë¶„ì„í•˜ì—¬ ê°ê´€ì ì¸ ì œí’ˆ í‰ê°€ë¥¼ ì œê³µí•©ë‹ˆë‹¤">
    <meta name="keywords" content="ì œí’ˆ ë¦¬ë·°, AI ë¶„ì„, ì œí’ˆ ë¹„êµ, ì‹¤ì‚¬ìš© í›„ê¸°">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    
    <!-- Security Headers -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https:;">
    
    <title>AI ì œí’ˆ ë¶„ì„ê¸° - ì‹¤ì‚¬ìš© ë¦¬ë·° ê¸°ë°˜ ë¶„ì„</title>
    
    <!-- Preconnect for performance -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Markdown rendering library (marked.js) -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js" defer></script>
    
    <style>
        /* ============ CSS Variables ============ */
        :root {
            --primary: #1a73e8;
            --primary-dark: #1557b0;
            --secondary: #5f6368;
            --bg: #f8f9fa;
            --bg-secondary: #ffffff;
            --text: #202124;
            --text-secondary: #5f6368;
            --border: #e0e0e0;
            --success: #1e8e3e;
            --error: #d93025;
            --warning: #f9ab00;
            --shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
            --shadow-lg: 0 10px 40px rgba(0,0,0,0.1);
            --radius: 12px;
            --radius-lg: 20px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Dark mode variables */
        [data-theme="dark"] {
            --bg: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --text: #e8eaed;
            --text-secondary: #9aa0a6;
            --border: #3c4043;
            --shadow: 0 1px 3px rgba(0,0,0,0.3);
            --shadow-lg: 0 10px 40px rgba(0,0,0,0.5);
        }

        /* ============ Reset & Base ============ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.7;
            padding: 20px;
            transition: var(--transition);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* ============ Container ============ */
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: var(--bg-secondary);
            padding: 40px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            transition: var(--transition);
        }

        /* ============ Header ============ */
        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            color: var(--primary);
            font-size: clamp(24px, 5vw, 32px);
            font-weight: 700;
            margin-bottom: 12px;
        }

        .header p {
            color: var(--text-secondary);
            font-size: 15px;
            max-width: 600px;
            margin: 0 auto;
        }

        /* ============ Controls ============ */
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            gap: 10px;
            flex-wrap: wrap;
        }

        .theme-toggle {
            background: none;
            border: 2px solid var(--border);
            color: var(--text);
            padding: 8px 16px;
            border-radius: var(--radius);
            cursor: pointer;
            font-size: 14px;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .theme-toggle:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .history-btn {
            background: none;
            border: 2px solid var(--border);
            color: var(--text);
            padding: 8px 16px;
            border-radius: var(--radius);
            cursor: pointer;
            font-size: 14px;
            transition: var(--transition);
        }

        .history-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        /* ============ Input Group ============ */
        .input-group {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }

        input {
            flex: 1;
            padding: 16px 20px;
            border: 2px solid var(--border);
            border-radius: var(--radius);
            font-size: 16px;
            outline: none;
            background: var(--bg-secondary);
            color: var(--text);
            transition: var(--transition);
        }

        input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.1);
        }

        input::placeholder {
            color: var(--text-secondary);
        }

        button.primary {
            padding: 16px 32px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius);
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: var(--transition);
            white-space: nowrap;
        }

        button.primary:hover:not(:disabled) {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        button.primary:active:not(:disabled) {
            transform: translateY(0);
        }

        button.primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* ============ Status Bar ============ */
        .status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 15px;
            padding: 12px;
            border-radius: var(--radius);
            transition: var(--transition);
        }

        .status.loading {
            background: rgba(26, 115, 232, 0.1);
            color: var(--primary);
        }

        .status.success {
            background: rgba(30, 142, 62, 0.1);
            color: var(--success);
        }

        .status.error {
            background: rgba(217, 48, 37, 0.1);
            color: var(--error);
        }

        /* Loading spinner */
        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid transparent;
            border-top-color: currentColor;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ============ Result Area ============ */
        .result-container {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 30px;
            min-height: 300px;
            position: relative;
        }

        .result-actions {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            gap: 8px;
        }

        .action-btn {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            transition: var(--transition);
        }

        .action-btn:hover {
            background: var(--border);
        }

        #result {
            font-size: 15px;
            line-height: 1.8;
            color: var(--text);
        }

        /* Markdown styling */
        #result h1, #result h2 {
            color: var(--text);
            margin-top: 24px;
            margin-bottom: 12px;
            font-weight: 600;
        }

        #result h2 {
            font-size: 20px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--border);
        }

        #result h3 {
            color: var(--text);
            font-size: 17px;
            margin-top: 16px;
            margin-bottom: 8px;
        }

        #result p {
            margin-bottom: 12px;
        }

        #result ul, #result ol {
            margin-left: 20px;
            margin-bottom: 12px;
        }

        #result li {
            margin-bottom: 6px;
        }

        #result strong {
            color: var(--text);
            font-weight: 600;
        }

        #result code {
            background: var(--bg);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 14px;
            font-family: 'Courier New', monospace;
        }

        /* ============ History Modal ============ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: 30px;
            max-width: 600px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            color: var(--text);
            font-size: 20px;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
        }

        .history-item {
            padding: 15px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            margin-bottom: 10px;
            cursor: pointer;
            transition: var(--transition);
        }

        .history-item:hover {
            background: var(--bg);
            border-color: var(--primary);
        }

        .history-item-title {
            font-weight: 600;
            color: var(--text);
            margin-bottom: 5px;
        }

        .history-item-time {
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* ============ Responsive ============ */
        @media (max-width: 768px) {
            .container {
                padding: 24px;
            }

            .input-group {
                flex-direction: column;
            }

            button.primary {
                width: 100%;
            }

            .controls {
                justify-content: center;
            }

            .result-actions {
                position: static;
                margin-bottom: 15px;
                justify-content: flex-end;
            }
        }

        /* ============ Accessibility ============ */
        .visually-hidden {
            position: absolute;
            width: 1px;
            height: 1px;
            margin: -1px;
            padding: 0;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            border: 0;
        }

        /* Focus visible for keyboard navigation */
        *:focus-visible {
            outline: 2px solid var(--primary);
            outline-offset: 2px;
        }

        /* ============ Animations ============ */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1>ë¦¬ë·° ìˆ˜ì§‘ë¶€í„° AI ìš”ì•½ê¹Œì§€, í•œëˆˆì— í™•ì¸í•˜ì„¸ìš”.</h1>
            <p>ì‹¤ì‹œê°„ ë¶„ì„ì„ í†µí•´ ì œí’ˆì˜ íŠ¹ì§•ê³¼ ì¥ë‹¨ì ì„ ì™„ë²½íˆ ì •ë¦¬í•´ ë“œë¦½ë‹ˆë‹¤.</p>
        </header>

        <!-- Controls -->
        <div class="controls">
            <button class="theme-toggle" onclick="toggleTheme()" aria-label="ë‹¤í¬ëª¨ë“œ ì „í™˜">
                <span id="themeIcon">ğŸŒ™</span>
                <span id="themeText">ë‹¤í¬ëª¨ë“œ</span>
            </button>
            <button class="history-btn" onclick="toggleHistory()" aria-label="ê²€ìƒ‰ ê¸°ë¡ ë³´ê¸°">
                ğŸ“œ ê²€ìƒ‰ ê¸°ë¡
            </button>
        </div>

        <!-- Input Group -->
        <div class="input-group">
            <label for="pName" class="visually-hidden">ë¶„ì„í•  ì œí’ˆëª… ì…ë ¥</label>
            <input 
                type="text" 
                id="pName" 
                placeholder="ë¶„ì„í•  ì œí’ˆëª…ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ê°¤ëŸ­ì‹œ ë²„ì¦ˆ 2)"
                maxlength="100"
                autocomplete="off"
                onkeypress="handleKeyPress(event)"
                aria-label="ì œí’ˆëª… ì…ë ¥"
            >
            <button class="primary" onclick="run()" id="analyzeBtn">
                ë¦¬í¬íŠ¸ ìƒì„±
            </button>
        </div>

        <!-- Status -->
        <div id="status" class="status" role="status" aria-live="polite" style="display: none;"></div>

        <!-- Result -->
        <div class="result-container">
            <div class="result-actions" id="resultActions" style="display: none;">
                <button class="action-btn" onclick="copyResult()" aria-label="ê²°ê³¼ ë³µì‚¬">
                    ğŸ“‹ ë³µì‚¬
                </button>
                <button class="action-btn" onclick="downloadResult()" aria-label="ê²°ê³¼ ë‹¤ìš´ë¡œë“œ">
                    ğŸ’¾ ì €ì¥
                </button>
            </div>
            <div id="result">
                <p style="color: var(--text-secondary);">ì œí’ˆëª…ì„ ì…ë ¥í•˜ë©´ AI ë¶„ì„ ë¦¬í¬íŠ¸ê°€ ìƒì„±ë©ë‹ˆë‹¤.</p>
            </div>
        </div>
    </div>

    <!-- History Modal -->
    <div class="modal" id="historyModal" onclick="closeModalOnBackdrop(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3>ê²€ìƒ‰ ê¸°ë¡</h3>
                <button class="close-btn" onclick="toggleHistory()" aria-label="ë‹«ê¸°">&times;</button>
            </div>
            <div id="historyList">
                <p style="color: var(--text-secondary); text-align: center;">ê²€ìƒ‰ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>
            </div>
        </div>
    </div>

    <script>
        // ============ State Management ============
        let currentResult = '';
        let currentProduct = '';
        let isAnalyzing = false;

        // ============ Theme Management ============
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            
            const icon = document.getElementById('themeIcon');
            const text = document.getElementById('themeText');
            
            if (newTheme === 'dark') {
                icon.textContent = 'â˜€ï¸';
                text.textContent = 'ë¼ì´íŠ¸ëª¨ë“œ';
            } else {
                icon.textContent = 'ğŸŒ™';
                text.textContent = 'ë‹¤í¬ëª¨ë“œ';
            }
        }

        // Load saved theme
        function loadTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            
            if (savedTheme === 'dark') {
                document.getElementById('themeIcon').textContent = 'â˜€ï¸';
                document.getElementById('themeText').textContent = 'ë¼ì´íŠ¸ëª¨ë“œ';
            }
        }

        // ============ Input Validation & Security ============
        function sanitizeInput(input) {
            // Remove potentially dangerous characters
            return input
                .replace(/[<>]/g, '')
                .replace(/javascript:/gi, '')
                .replace(/on\w+=/gi, '')
                .trim();
        }

        function validateInput(input) {
            if (!input || input.length === 0) {
                return { valid: false, message: 'ì œí’ˆëª…ì„ ì…ë ¥í•˜ì„¸ìš”.' };
            }
            if (input.length > 100) {
                return { valid: false, message: 'ì œí’ˆëª…ì€ 100ì ì´í•˜ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.' };
            }
            // Check for suspicious patterns
            const dangerousPatterns = /<script|javascript:|onerror=|onclick=/i;
            if (dangerousPatterns.test(input)) {
                return { valid: false, message: 'ìœ íš¨í•˜ì§€ ì•Šì€ ì…ë ¥ì…ë‹ˆë‹¤.' };
            }
            return { valid: true };
        }

        // ============ Rate Limiting (Client-side) ============
        let lastRequestTime = 0;
        const MIN_REQUEST_INTERVAL = 3000; // 3 seconds

        function checkRateLimit() {
            const now = Date.now();
            if (now - lastRequestTime < MIN_REQUEST_INTERVAL) {
                const remainingTime = Math.ceil((MIN_REQUEST_INTERVAL - (now - lastRequestTime)) / 1000);
                return { allowed: false, message: `${remainingTime}ì´ˆ í›„ì— ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.` };
            }
            lastRequestTime = now;
            return { allowed: true };
        }

        // ============ Status Management ============
        function showStatus(message, type = 'loading') {
            const statusDiv = document.getElementById('status');
            statusDiv.style.display = 'flex';
            statusDiv.className = `status ${type}`;
            
            if (type === 'loading') {
                statusDiv.innerHTML = `<div class="spinner"></div><span>${message}</span>`;
            } else {
                const icon = type === 'success' ? 'âœ…' : 'âŒ';
                statusDiv.innerHTML = `<span>${icon} ${message}</span>`;
            }
        }

        function hideStatus() {
            document.getElementById('status').style.display = 'none';
        }

        // ============ Main Analysis Function ============
        async function run() {
            if (isAnalyzing) return;

            const pName = document.getElementById('pName').value;
            const resultDiv = document.getElementById('result');
            const analyzeBtn = document.getElementById('analyzeBtn');
            const resultActions = document.getElementById('resultActions');

            // Validate input
            const validation = validateInput(pName);
            if (!validation.valid) {
                showStatus(validation.message, 'error');
                setTimeout(hideStatus, 3000);
                return;
            }

            // Check rate limit
            const rateLimit = checkRateLimit();
            if (!rateLimit.allowed) {
                showStatus(rateLimit.message, 'error');
                setTimeout(hideStatus, 3000);
                return;
            }

            // Sanitize input
            const cleanInput = sanitizeInput(pName);
            currentProduct = cleanInput;

            // Set loading state
            isAnalyzing = true;
            analyzeBtn.disabled = true;
            resultActions.style.display = 'none';
            
            showStatus('ğŸ” ì‹¤ì‹œê°„ ë¦¬ë·°ë¥¼ íƒìƒ‰í•˜ê³  ê²€ìˆ˜ ì¤‘...', 'loading');
            resultDiv.innerHTML = '<p style="color: var(--text-secondary);">AIê°€ ë¦¬í¬íŠ¸ë¥¼ ì‘ì„± ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”...</p>';

            const fd = new FormData();
            fd.append('user_input', cleanInput);

            try {
                const res = await fetch('/chat', { 
                    method: 'POST', 
                    body: fd,
                    // Add timeout
                    signal: AbortSignal.timeout(60000) // 60 seconds
                });

                if (!res.ok) {
                    throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                }

                const data = await res.json();

                if (data.error) {
                    throw new Error(data.error);
                }

                // Success
                currentResult = data.answer;
                
                // Render markdown if marked.js is available
                if (typeof marked !== 'undefined') {
                    resultDiv.innerHTML = marked.parse(currentResult);
                } else {
                    // Fallback to plain text with basic formatting
                    resultDiv.innerHTML = formatText(currentResult);
                }
                
                resultDiv.classList.add('fade-in');
                showStatus(data.data_info || 'ë¶„ì„ ì™„ë£Œ', 'success');
                resultActions.style.display = 'flex';

                // Save to history
                saveToHistory(cleanInput, currentResult);

            } catch (error) {
                console.error('Analysis error:', error);
                let errorMessage = 'ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                
                if (error.name === 'AbortError') {
                    errorMessage = 'ìš”ì²­ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
                } else if (error.message) {
                    errorMessage = error.message;
                }
                
                resultDiv.innerHTML = `<p style="color: var(--error);">${errorMessage}</p>`;
                showStatus(errorMessage, 'error');
            } finally {
                isAnalyzing = false;
                analyzeBtn.disabled = false;
                
                // Hide status after 5 seconds
                setTimeout(hideStatus, 5000);
            }
        }

        // ============ Text Formatting (Fallback) ============
        function formatText(text) {
            return text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/\n/g, '<br>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/^## (.*$)/gm, '<h2>$1</h2>')
                .replace(/^### (.*$)/gm, '<h3>$1</h3>');
        }

        // ============ Copy Function ============
        async function copyResult() {
            try {
                await navigator.clipboard.writeText(currentResult);
                showStatus('í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
                setTimeout(hideStatus, 2000);
            } catch (error) {
                showStatus('ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'error');
                setTimeout(hideStatus, 2000);
            }
        }

        // ============ Download Function ============
        function downloadResult() {
            const blob = new Blob([currentResult], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${currentProduct}_ë¶„ì„ë¦¬í¬íŠ¸.md`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showStatus('íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
            setTimeout(hideStatus, 2000);
        }

        // ============ History Management ============
        function saveToHistory(product, result) {
            let history = JSON.parse(localStorage.getItem('searchHistory') || '[]');
            
            // Add new entry
            history.unshift({
                product: product,
                result: result,
                timestamp: new Date().toISOString()
            });
            
            // Keep only last 10 entries
            history = history.slice(0, 10);
            
            localStorage.setItem('searchHistory', JSON.stringify(history));
        }

        function toggleHistory() {
            const modal = document.getElementById('historyModal');
            const isActive = modal.classList.contains('active');
            
            if (isActive) {
                modal.classList.remove('active');
            } else {
                loadHistory();
                modal.classList.add('active');
            }
        }

        function loadHistory() {
            const history = JSON.parse(localStorage.getItem('searchHistory') || '[]');
            const listDiv = document.getElementById('historyList');
            
            if (history.length === 0) {
                listDiv.innerHTML = '<p style="color: var(--text-secondary); text-align: center;">ê²€ìƒ‰ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }
            
            listDiv.innerHTML = history.map((item, index) => {
                const date = new Date(item.timestamp);
                const timeStr = date.toLocaleString('ko-KR');
                
                return `
                    <div class="history-item" onclick="loadHistoryItem(${index})">
                        <div class="history-item-title">${escapeHtml(item.product)}</div>
                        <div class="history-item-time">${timeStr}</div>
                    </div>
                `;
            }).join('');
        }

        function loadHistoryItem(index) {
            const history = JSON.parse(localStorage.getItem('searchHistory') || '[]');
            const item = history[index];
            
            if (item) {
                document.getElementById('pName').value = item.product;
                currentProduct = item.product;
                currentResult = item.result;
                
                const resultDiv = document.getElementById('result');
                if (typeof marked !== 'undefined') {
                    resultDiv.innerHTML = marked.parse(item.result);
                } else {
                    resultDiv.innerHTML = formatText(item.result);
                }
                
                document.getElementById('resultActions').style.display = 'flex';
                toggleHistory();
                
                showStatus('ê¸°ë¡ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤', 'success');
                setTimeout(hideStatus, 2000);
            }
        }

        function closeModalOnBackdrop(event) {
            if (event.target.id === 'historyModal') {
                toggleHistory();
            }
        }

        // ============ Keyboard Shortcuts ============
        function handleKeyPress(event) {
            if (event.key === 'Enter' && !isAnalyzing) {
                run();
            }
        }

        // ESC to close modal
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                const modal = document.getElementById('historyModal');
                if (modal.classList.contains('active')) {
                    toggleHistory();
                }
            }
        });

        // ============ Utility Functions ============
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ============ Initialize ============
        document.addEventListener('DOMContentLoaded', () => {
            loadTheme();
            
            // Auto-focus input
            document.getElementById('pName').focus();
        });

        // Performance optimization: Prevent multiple clicks
        let clickTimeout;
        document.getElementById('analyzeBtn').addEventListener('click', () => {
            if (clickTimeout) return;
            clickTimeout = setTimeout(() => {
                clickTimeout = null;
            }, 1000);
        });
    </script>
</body>
</html>
