<!DOCTYPE html>
<html lang="ko" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="ì‹¤ì œ ì‚¬ìš©ì ë¦¬ë·°ë¥¼ AIê°€ ë¶„ì„í•˜ì—¬ ì œí’ˆì˜ ì¥ë‹¨ì ì„ í•œëˆˆì— ì •ë¦¬í•´ë“œë¦½ë‹ˆë‹¤.">
  <!-- â˜… ë³´ì•ˆ: Content Security Policy -->
  <meta http-equiv="Content-Security-Policy"
    content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline'; connect-src 'self'; img-src 'self' data:;">
  <title>AI ì œí’ˆ ë¶„ì„ê¸°</title>

  <!-- marked: ë§ˆí¬ë‹¤ìš´ ë Œë”ëŸ¬ -->
  <script src="https://cdn.jsdelivr.net/npm/marked@9.1.6/marked.min.js" crossorigin="anonymous"></script>
  <!-- â˜… DOMPurify: XSS ë°©ì–´ â€” marked ê²°ê³¼ ì •ì œ í•„ìˆ˜ -->
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.5/dist/purify.min.js" crossorigin="anonymous"></script>

  <style>
    /* â•â• ë””ìì¸ í† í° â•â• */
    :root {
      --bg:        #f2f4f8;
      --surface:   #ffffff;
      --surface2:  #f8f9fc;
      --border:    #e2e6ed;
      --border2:   #d0d5de;
      --primary:   #2563eb;
      --primary-h: #1d4ed8;
      --primary-lt:#eff4ff;
      --danger:    #dc2626;
      --danger-lt: #fef2f2;
      --warn:      #d97706;
      --warn-lt:   #fffbeb;
      --warn-bd:   #fde68a;
      --success:   #16a34a;
      --text:      #0f1117;
      --text2:     #4b5563;
      --text3:     #9ca3af;
      --r: 10px;
      --sh-sm: 0 1px 3px rgba(0,0,0,.07), 0 1px 2px rgba(0,0,0,.04);
      --sh:    0 4px 16px rgba(0,0,0,.08), 0 1px 4px rgba(0,0,0,.05);
      --sh-lg: 0 12px 40px rgba(0,0,0,.10), 0 2px 8px rgba(0,0,0,.06);
      --font: 'Malgun Gothic','ë§‘ì€ ê³ ë”•',-apple-system,'Apple SD Gothic Neo','Nanum Gothic',sans-serif;
    }
    [data-theme="dark"] {
      --bg:        #0d1117;
      --surface:   #161b22;
      --surface2:  #21262d;
      --border:    #30363d;
      --border2:   #3d444d;
      --primary:   #3b82f6;
      --primary-h: #2563eb;
      --primary-lt:#1a2540;
      --danger:    #f87171;
      --danger-lt: #1f1214;
      --warn:      #fbbf24;
      --warn-lt:   #1c1506;
      --warn-bd:   #78350f;
      --success:   #3fb950;
      --text:      #e6edf3;
      --text2:     #9198a1;
      --text3:     #545d68;
      --sh-sm: 0 1px 3px rgba(0,0,0,.3);
      --sh:    0 4px 16px rgba(0,0,0,.4);
      --sh-lg: 0 12px 40px rgba(0,0,0,.5);
    }

    /* â•â• ê¸°ë³¸ â•â• */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html { scroll-behavior: smooth; }
    body {
      font-family: var(--font);
      background: var(--bg); color: var(--text);
      min-height: 100vh;
      transition: background .3s, color .3s;
      font-size: 14px; line-height: 1.6;
    }
    :focus-visible { outline: 2px solid var(--primary); outline-offset: 2px; }

    /* â•â• ë„¤ë¹„ â•â• */
    nav {
      position: sticky; top: 0; z-index: 100;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      box-shadow: var(--sh-sm);
    }
    .nav-inner {
      max-width: 780px; margin: 0 auto;
      padding: 0 20px; height: 56px;
      display: flex; align-items: center; justify-content: space-between;
    }
    .nav-logo { display: flex; align-items: center; gap: 10px; }
    .nav-icon {
      width: 32px; height: 32px; background: var(--primary);
      border-radius: 8px; display: flex; align-items: center;
      justify-content: center; color: #fff;
      font-size: 13px; font-weight: 800; flex-shrink: 0;
    }
    .nav-title { font-size: 16px; font-weight: 700; color: var(--text); }
    .nav-title span { color: var(--primary); }
    .nav-badge {
      font-size: 10px; background: var(--primary-lt); color: var(--primary);
      padding: 2px 7px; border-radius: 20px; font-weight: 600;
      border: 1px solid rgba(37,99,235,.3);
    }
    .theme-toggle {
      width: 36px; height: 36px; border-radius: 8px;
      border: 1px solid var(--border); background: var(--surface2);
      cursor: pointer; display: flex; align-items: center;
      justify-content: center; font-size: 17px; transition: .15s;
    }
    .theme-toggle:hover { background: var(--border); }

    /* â•â• ë©”ì¸ â•â• */
    main { max-width: 780px; margin: 0 auto; padding: 32px 20px 80px; }

    /* â•â• íˆì–´ë¡œ â•â• */
    .hero { text-align: center; padding: 36px 0 32px; }
    .hero-badge {
      display: inline-flex; align-items: center; gap: 6px;
      font-size: 12px; color: var(--primary); font-weight: 600;
      background: var(--primary-lt); border: 1px solid rgba(37,99,235,.3);
      border-radius: 20px; padding: 4px 12px; margin-bottom: 18px;
    }
    .hero-badge-dot { width: 6px; height: 6px; background: var(--primary); border-radius: 50%; }
    .hero h2 {
      font-size: clamp(22px,4vw,32px); font-weight: 800; color: var(--text);
      letter-spacing: -.8px; line-height: 1.3; margin-bottom: 12px;
    }
    .hero h2 em { font-style: normal; color: var(--primary); }
    .hero p { font-size: 14px; color: var(--text2); line-height: 1.8; }

    /* â•â• ê²€ìƒ‰ ì¹´ë“œ â•â• */
    .search-card {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 14px; padding: 22px 24px;
      box-shadow: var(--sh); margin-bottom: 14px;
    }
    .search-label {
      font-size: 12px; font-weight: 700; color: var(--text2);
      margin-bottom: 10px; display: flex; align-items: center; gap: 7px;
    }
    .search-label-bar { width: 3px; height: 13px; background: var(--primary); border-radius: 2px; }
    .search-row { display: flex; gap: 8px; }
    .input-wrap { flex: 1; position: relative; }
    .input-wrap::before {
      content: 'ğŸ”'; position: absolute; left: 12px; top: 50%;
      transform: translateY(-50%); font-size: 14px; pointer-events: none;
    }
    /* â˜… ê¸€ì ìˆ˜ ì¹´ìš´í„° */
    .char-counter {
      position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
      font-size: 11px; color: var(--text3); pointer-events: none; transition: color .2s;
    }
    .char-counter.warn { color: var(--warn); }
    .char-counter.over { color: var(--danger); }

    input[type="text"] {
      width: 100%; padding: 11px 52px 11px 38px;
      border: 1.5px solid var(--border); border-radius: var(--r);
      background: var(--surface2); color: var(--text);
      font-family: var(--font); font-size: 14px;
      transition: .15s; outline: none;
    }
    input:focus { border-color: var(--primary); background: var(--surface); box-shadow: 0 0 0 3px rgba(37,99,235,.1); }
    input::placeholder { color: var(--text3); }
    input[aria-invalid="true"] { border-color: var(--danger); }

    .btn-primary {
      padding: 11px 22px; background: var(--primary); color: #fff;
      border: none; border-radius: var(--r); font-family: var(--font);
      font-size: 14px; font-weight: 700; cursor: pointer;
      transition: .15s; white-space: nowrap;
      display: flex; align-items: center; gap: 6px;
    }
    .btn-primary:hover:not(:disabled) { background: var(--primary-h); transform: translateY(-1px); box-shadow: 0 4px 12px rgba(37,99,235,.3); }
    .btn-primary:active:not(:disabled) { transform: none; }
    .btn-primary:disabled { opacity: .5; cursor: not-allowed; }

    /* â•â• ì…ë ¥ ì—ëŸ¬ â•â• */
    .input-error {
      font-size: 12px; color: var(--danger); margin-top: 7px;
      display: none; align-items: center; gap: 5px;
    }
    .input-error.show { display: flex; }

    /* â•â• íˆìŠ¤í† ë¦¬ â•â• */
    .history-row {
      display: none; align-items: center; gap: 6px; flex-wrap: wrap;
      margin-top: 14px; padding-top: 14px; border-top: 1px solid var(--border);
    }
    .history-row.show { display: flex; }
    .history-label { font-size: 11px; color: var(--text3); font-weight: 600; white-space: nowrap; }
    .history-chip {
      font-size: 12px; padding: 4px 11px;
      border: 1px solid var(--border2); border-radius: 20px;
      cursor: pointer; color: var(--text2); background: var(--surface2);
      font-family: var(--font); transition: .15s;
    }
    .history-chip:hover { border-color: var(--primary); color: var(--primary); background: var(--primary-lt); }
    /* â˜… íˆìŠ¤í† ë¦¬ ì „ì²´ ì‚­ì œ ë²„íŠ¼ */
    .history-clear {
      margin-left: auto; font-size: 11px; color: var(--text3);
      background: none; border: none; cursor: pointer;
      padding: 2px 6px; border-radius: 4px;
      transition: .15s; font-family: var(--font);
    }
    .history-clear:hover { color: var(--danger); background: var(--danger-lt); }

    /* â•â• AI ì¶”ì • ë°°ë„ˆ â•â• */
    .estimate-banner {
      background: var(--warn-lt); border: 1px solid var(--warn-bd);
      border-radius: 12px; padding: 12px 18px; margin-bottom: 14px;
      display: none; align-items: center; gap: 10px;
      font-size: 13px; color: var(--warn);
    }
    .estimate-banner.show { display: flex; }

    /* â•â• ì—ëŸ¬ ì¹´ë“œ â•â• */
    .error-card {
      background: var(--danger-lt); border: 1px solid var(--danger);
      border-radius: 12px; padding: 14px 18px; margin-bottom: 14px;
      display: none; align-items: center; gap: 10px;
      font-size: 13px; color: var(--danger);
    }
    .error-card.show { display: flex; }
    .error-text { flex: 1; font-weight: 500; }
    .btn-retry {
      padding: 6px 14px; background: var(--danger); color: #fff;
      border: none; border-radius: 7px; font-family: var(--font);
      font-size: 12px; font-weight: 700; cursor: pointer; white-space: nowrap;
    }
    .btn-retry:hover { opacity: .85; }

    /* â•â• ì§„í–‰ ì¹´ë“œ â•â• */
    .progress-card {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 12px; padding: 18px 22px;
      box-shadow: var(--sh-sm); margin-bottom: 14px; display: none;
    }
    .progress-card.show { display: block; }
    .progress-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 11px; }
    .progress-status { display: flex; align-items: center; gap: 8px; font-size: 13px; color: var(--text2); font-weight: 500; }
    .spinner {
      width: 14px; height: 14px;
      border: 2px solid var(--border); border-top-color: var(--primary);
      border-radius: 50%; animation: spin .7s linear infinite; flex-shrink: 0;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .progress-pct { font-size: 13px; font-weight: 700; color: var(--primary); }
    .progress-track { height: 5px; background: var(--surface2); border-radius: 3px; overflow: hidden; border: 1px solid var(--border); }
    .progress-bar {
      height: 100%; width: 0%; border-radius: 3px;
      background: linear-gradient(90deg, var(--primary), #60a5fa);
      transition: width .4s cubic-bezier(.4,0,.2,1);
    }

    /* â•â• ìŠ¤ì¼ˆë ˆí†¤ â•â• */
    .skeleton-card {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 14px; padding: 26px; margin-bottom: 14px; display: none;
    }
    .skeleton-card.show { display: block; }
    .skel {
      height: 13px; border-radius: 6px; margin-bottom: 10px;
      background: linear-gradient(90deg, var(--border) 25%, var(--surface2) 50%, var(--border) 75%);
      background-size: 300% 100%; animation: shimmer 1.6s infinite;
    }
    .skel-h { height: 18px; margin-bottom: 16px; }
    @keyframes shimmer { 0%{background-position:200%} 100%{background-position:-200%} }

    /* â•â• ê²°ê³¼ ì¹´ë“œ â•â• */
    .result-card {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 14px; overflow: hidden;
      box-shadow: var(--sh-lg); display: none;
      animation: slideUp .4s cubic-bezier(.16,1,.3,1);
    }
    .result-card.show { display: block; }
    @keyframes slideUp { from{opacity:0;transform:translateY(14px)} to{opacity:1;transform:none} }

    .result-header {
      padding: 14px 22px; border-bottom: 1px solid var(--border);
      background: var(--surface2); display: flex;
      align-items: center; justify-content: space-between; gap: 12px;
    }
    .result-meta { display: flex; align-items: center; gap: 9px; min-width: 0; }
    .result-dot {
      width: 8px; height: 8px; background: var(--success);
      border-radius: 50%; flex-shrink: 0;
      box-shadow: 0 0 0 3px rgba(22,163,74,.15);
    }
    .result-dot.warn { background: var(--warn); box-shadow: 0 0 0 3px rgba(217,119,6,.15); }
    .result-meta-info { min-width: 0; }
    .result-product { font-weight: 700; font-size: 14px; color: var(--text); display: block; }
    .result-sub { font-size: 11px; color: var(--text3); }
    .result-actions { display: flex; gap: 6px; flex-shrink: 0; }
    .btn-action {
      padding: 6px 13px; border: 1px solid var(--border2); border-radius: 7px;
      background: var(--surface); color: var(--text2); font-family: var(--font);
      font-size: 12px; font-weight: 600; cursor: pointer;
      transition: .15s; display: flex; align-items: center; gap: 4px;
    }
    .btn-action:hover { border-color: var(--primary); color: var(--primary); background: var(--primary-lt); }

    /* â•â• ê²°ê³¼ ë³¸ë¬¸ ë§ˆí¬ë‹¤ìš´ â•â• */
    .result-body { padding: 26px 26px 30px; }
    .result-body h2 {
      font-size: 16px; font-weight: 800; color: var(--text);
      margin: 26px 0 10px; padding: 9px 14px;
      background: var(--surface2); border-left: 3.5px solid var(--primary);
      border-radius: 0 6px 6px 0;
    }
    .result-body h2:first-child { margin-top: 0; }
    .result-body h3 { font-size: 14px; font-weight: 700; color: var(--text2); margin: 16px 0 7px; }
    .result-body p { font-size: 14px; color: var(--text); margin-bottom: 11px; line-height: 1.85; }
    .result-body ul, .result-body ol { padding-left: 18px; margin-bottom: 11px; }
    .result-body li { font-size: 14px; color: var(--text); margin-bottom: 5px; line-height: 1.75; }
    .result-body strong { color: var(--primary); font-weight: 700; }
    .result-body em { font-style: italic; }
    .result-body code {
      font-size: 12px; background: var(--surface2); padding: 2px 6px;
      border-radius: 4px; border: 1px solid var(--border);
      font-family: 'Consolas','Courier New',monospace;
    }
    .result-body hr { border: none; border-top: 1px solid var(--border); margin: 18px 0; }
    .result-body blockquote {
      border-left: 3px solid var(--primary-lt); margin: 12px 0;
      padding: 8px 14px; background: var(--surface2);
      border-radius: 0 6px 6px 0; color: var(--text2); font-size: 13px;
    }
    /* â˜… AI ì ìˆ˜ í…Œì´ë¸” ìŠ¤íƒ€ì¼ (í•„ìˆ˜ â€” ì—†ìœ¼ë©´ í…Œì´ë¸”ì´ ë­‰ê°œì§) */
    .result-body table {
      width: 100%; border-collapse: collapse;
      margin: 16px 0; font-size: 13px;
      border: 1px solid var(--border); border-radius: 8px; overflow: hidden;
    }
    .result-body th {
      background: var(--primary-lt); color: var(--primary);
      font-weight: 700; padding: 10px 14px; text-align: left;
      border-bottom: 1px solid var(--border);
    }
    .result-body td {
      padding: 9px 14px; border-bottom: 1px solid var(--border); color: var(--text);
    }
    .result-body tr:last-child td { border-bottom: none; }
    .result-body tr:nth-child(even) td { background: var(--surface2); }
    .result-body tr:hover td { background: var(--primary-lt); transition: .15s; }

    /* â•â• í† ìŠ¤íŠ¸ â•â• */
    .toast {
      position: fixed; bottom: 28px; left: 50%;
      transform: translateX(-50%) translateY(10px);
      background: #1f2937; color: #f9fafb;
      font-family: var(--font); font-size: 13px; font-weight: 600;
      padding: 11px 20px; border-radius: 10px;
      box-shadow: var(--sh-lg); opacity: 0;
      pointer-events: none; transition: .25s; z-index: 999; white-space: nowrap;
    }
    [data-theme="dark"] .toast { background: #e6edf3; color: #0d1117; }
    .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

    /* â•â• ë°˜ì‘í˜• â•â• */
    @media (max-width: 500px) {
      .search-row { flex-direction: column; }
      .result-header { flex-direction: column; align-items: flex-start; }
      .result-actions { width: 100%; }
      .btn-action { flex: 1; justify-content: center; }
      .result-body { padding: 18px 16px 22px; }
      .result-body table { font-size: 12px; }
      .result-body th, .result-body td { padding: 7px 10px; }
      main { padding: 20px 14px 60px; }
    }
  </style>
</head>
<body>

<nav role="navigation" aria-label="ë©”ì¸ ë„¤ë¹„ê²Œì´ì…˜">
  <div class="nav-inner">
    <div class="nav-logo">
      <div class="nav-icon" aria-hidden="true">AI</div>
      <span class="nav-title">AI <span>ì œí’ˆ ë¶„ì„ê¸°</span></span>
      <span class="nav-badge">Beta</span>
    </div>
    <button class="theme-toggle" id="themeBtn" onclick="toggleTheme()" aria-label="í…Œë§ˆ ì „í™˜">ğŸŒ™</button>
  </div>
</nav>

<main>
  <!-- íˆì–´ë¡œ -->
  <section class="hero" aria-label="ì„œë¹„ìŠ¤ ì†Œê°œ">
    <div class="hero-badge" aria-hidden="true">
      <div class="hero-badge-dot"></div>ì‹¤ì‹œê°„ ë¦¬ë·° ë¶„ì„ ì—”ì§„
    </div>
    <h2>ê¶ê¸ˆí•œ ì œí’ˆ,<br><em>AIê°€ ë¶„ì„í•´ ë“œë¦½ë‹ˆë‹¤</em></h2>
    <p>ì‹¤ì œ ì‚¬ìš©ì ë¦¬ë·°ë¥¼ ìˆ˜ì§‘Â·ë¶„ì„í•˜ì—¬<br>ì¥ë‹¨ì ì„ í•œëˆˆì— ì •ë¦¬í•´ ë“œë¦½ë‹ˆë‹¤.</p>
  </section>

  <!-- ê²€ìƒ‰ ì¹´ë“œ -->
  <section class="search-card" aria-label="ì œí’ˆ ê²€ìƒ‰">
    <div class="search-label" aria-hidden="true">
      <div class="search-label-bar"></div>ë¶„ì„í•  ì œí’ˆ ì…ë ¥
    </div>
    <div class="search-row">
      <div class="input-wrap">
        <input type="text" id="productInput"
          placeholder="ì˜ˆ: ê°¤ëŸ­ì‹œ S25, ë‹¤ì´ìŠ¨ ì—ì–´ë©, ë§¥ë¶ í”„ë¡œ M4â€¦"
          maxlength="100"
          autocomplete="off"
          autocorrect="off"
          spellcheck="false"
          aria-label="ì œí’ˆëª… ì…ë ¥"
          aria-describedby="inputError"
          onkeydown="handleKeydown(event)"
          oninput="handleInput(event)">
        <span class="char-counter" id="charCounter" aria-live="polite"></span>
      </div>
      <button class="btn-primary" id="analyzeBtn" onclick="runAnalysis()" aria-label="ë¶„ì„ ì‹œì‘">
        ë¶„ì„ ì‹œì‘ â†’
      </button>
    </div>
    <div class="input-error" id="inputError" role="alert" aria-live="assertive">
      <span id="inputErrorMsg"></span>
    </div>
    <div class="history-row" id="historyRow" aria-label="ìµœê·¼ ê²€ìƒ‰ ê¸°ë¡">
      <span class="history-label" aria-hidden="true">ìµœê·¼ ê²€ìƒ‰</span>
      <button class="history-clear" id="historyClearBtn" onclick="clearHistory()" aria-label="ê²€ìƒ‰ ê¸°ë¡ ì „ì²´ ì‚­ì œ">ì „ì²´ ì‚­ì œ</button>
    </div>
  </section>

  <!-- AI ì¶”ì • ë°°ë„ˆ -->
  <div class="estimate-banner" id="estimateBanner" role="status" aria-live="polite">
    <span aria-hidden="true">âš ï¸</span>
    <span>ì‹¤ì‹œê°„ ë¦¬ë·° ìˆ˜ì§‘ì— ì‹¤íŒ¨í•˜ì—¬ AI í•™ìŠµ ë°ì´í„° ê¸°ë°˜ìœ¼ë¡œ ë¶„ì„í•œ ê²°ê³¼ì…ë‹ˆë‹¤. ì‹¤ì œì™€ ë‹¤ë¥¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</span>
  </div>

  <!-- ì—ëŸ¬ ì¹´ë“œ -->
  <div class="error-card" id="errorCard" role="alert" aria-live="assertive">
    <span aria-hidden="true">âš ï¸</span>
    <span class="error-text" id="errorMsg">ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</span>
    <button class="btn-retry" onclick="retryAnalysis()" aria-label="ë‹¤ì‹œ ì‹œë„">ì¬ì‹œë„</button>
  </div>

  <!-- ì§„í–‰ ì¹´ë“œ -->
  <div class="progress-card" id="progressCard" role="status" aria-live="polite">
    <div class="progress-top">
      <div class="progress-status">
        <div class="spinner" aria-hidden="true"></div>
        <span id="statusMsg">ë¶„ì„ ì¤€ë¹„ ì¤‘...</span>
      </div>
      <span class="progress-pct" id="pctText">0%</span>
    </div>
    <div class="progress-track" role="progressbar"
         aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" id="progressTrack">
      <div class="progress-bar" id="progressBar"></div>
    </div>
  </div>

  <!-- ìŠ¤ì¼ˆë ˆí†¤ -->
  <div class="skeleton-card" id="skeletonCard" aria-hidden="true">
    <div class="skel skel-h" style="width:40%"></div>
    <div class="skel" style="width:100%"></div>
    <div class="skel" style="width:86%"></div>
    <div class="skel" style="width:72%"></div>
    <div style="height:14px"></div>
    <div class="skel skel-h" style="width:34%"></div>
    <div class="skel" style="width:93%"></div>
    <div class="skel" style="width:80%"></div>
    <div class="skel" style="width:65%"></div>
  </div>

  <!-- ê²°ê³¼ ì¹´ë“œ -->
  <div class="result-card" id="resultCard" aria-label="ë¶„ì„ ê²°ê³¼">
    <div class="result-header">
      <div class="result-meta">
        <div class="result-dot" id="resultDot"></div>
        <div class="result-meta-info">
          <span class="result-product" id="resultName"></span>
          <span class="result-sub" id="resultSub">ë¶„ì„ ì™„ë£Œ</span>
        </div>
      </div>
      <div class="result-actions">
        <button class="btn-action" onclick="copyResult()" aria-label="ê²°ê³¼ ë³µì‚¬">ğŸ“‹ ë³µì‚¬</button>
        <button class="btn-action" onclick="downloadResult()" aria-label="ê²°ê³¼ ì €ì¥">â¬‡ ì €ì¥</button>
      </div>
    </div>
    <div class="result-body" id="resultBody"></div>
  </div>
</main>

<div class="toast" id="toast" role="status" aria-live="polite"></div>

<script>
'use strict';

/* â”€â”€ ìƒìˆ˜ â”€â”€ */
const MAX_INPUT   = 100;
const MAX_RETRY   = 3;
const SSE_TIMEOUT = 120_000; // 2ë¶„
const HIST_KEY    = 'aiAnalyzerHistory';

/* â”€â”€ ìƒíƒœ â”€â”€ */
let isAnalyzing    = false;
let currentProduct = '';
let currentMarkdown= '';
let retryCount     = 0;
let isEstimate     = false;
let _sse           = null;   // í˜„ì¬ EventSource
let _sseTimer      = null;   // íƒ€ì„ì•„ì›ƒ íƒ€ì´ë¨¸
let _toastTimer    = null;

/* â”€â”€ marked ì„¤ì • â”€â”€
   gfm: true â†’ í…Œì´ë¸” ë Œë”ë§ ì§€ì›
   headerIds: false â†’ id ì†ì„± ë¯¸ìƒì„±ìœ¼ë¡œ XSS ê²½ë¡œ ì°¨ë‹¨ */
marked.setOptions({ breaks: true, gfm: true, headerIds: false, mangle: false });

/* â˜… ì•ˆì „í•œ ë§ˆí¬ë‹¤ìš´ ë Œë”ë§ (DOMPurify XSS ì •ì œ) */
function safeMarkdown(md) {
  const raw = marked.parse(md || '');
  if (typeof DOMPurify !== 'undefined') {
    return DOMPurify.sanitize(raw, {
      ALLOWED_TAGS: ['h1','h2','h3','h4','h5','h6','p','br','hr',
                     'ul','ol','li','strong','em','code','pre',
                     'blockquote','table','thead','tbody','tr','th','td',
                     'a','span'],
      ALLOWED_ATTR: ['href','target','rel','class'],
      FORCE_HTTPS: true,
    });
  }
  // DOMPurify ë¡œë“œ ì‹¤íŒ¨ ì‹œ ìŠ¤í¬ë¦½íŠ¸ ì œê±° í´ë°±
  console.warn('DOMPurify ë¯¸ë¡œë“œ â€” í´ë°± ì‚¬ìš©');
  return raw.replace(/<script[\s\S]*?<\/script>/gi, '')
            .replace(/javascript:/gi, '')
            .replace(/on\w+\s*=/gi, '');
}

/* â”€â”€ í…Œë§ˆ â”€â”€ */
(function() {
  const t = localStorage.getItem('theme') || 'light';
  document.documentElement.dataset.theme = t;
  document.getElementById('themeBtn').textContent = t === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
})();

function toggleTheme() {
  const html = document.documentElement;
  const next = html.dataset.theme === 'dark' ? 'light' : 'dark';
  html.dataset.theme = next;
  document.getElementById('themeBtn').textContent = next === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
  localStorage.setItem('theme', next);
}

/* â”€â”€ í† ìŠ¤íŠ¸ â”€â”€ */
function showToast(msg) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.classList.add('show');
  clearTimeout(_toastTimer);
  _toastTimer = setTimeout(() => el.classList.remove('show'), 2400);
}

/* â”€â”€ ì…ë ¥ ì²˜ë¦¬ â”€â”€ */
function handleKeydown(e) {
  // â˜… isComposing: í•œê¸€ ì¡°í•© ì¤‘ Enter ë°©ì§€
  if (e.key === 'Enter' && !e.isComposing) {
    e.preventDefault();
    runAnalysis();
  }
}

function handleInput(e) {
  const len = e.target.value.length;
  const counter = document.getElementById('charCounter');
  counter.textContent = len > 0 ? `${len}/${MAX_INPUT}` : '';
  counter.className = 'char-counter' + (len >= MAX_INPUT ? ' over' : len > 80 ? ' warn' : '');
  hideInputError();
  e.target.removeAttribute('aria-invalid');
}

/* â”€â”€ ì…ë ¥ ê²€ì¦ â”€â”€ */
function validateInput(name) {
  if (!name) { showInputError('ì œí’ˆëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return false; }
  if (name.length > MAX_INPUT) { showInputError(`${MAX_INPUT}ì ì´í•˜ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.`); return false; }
  const blocked = ['<script', 'javascript:', 'data:', '--'];
  if (blocked.some(b => name.toLowerCase().includes(b))) {
    showInputError('ìœ íš¨í•˜ì§€ ì•Šì€ ì…ë ¥ì…ë‹ˆë‹¤.');
    return false;
  }
  return true;
}

function showInputError(msg) {
  document.getElementById('productInput').setAttribute('aria-invalid', 'true');
  document.getElementById('inputErrorMsg').textContent = msg;
  document.getElementById('inputError').classList.add('show');
}
function hideInputError() {
  document.getElementById('inputError').classList.remove('show');
}

/* â”€â”€ íˆìŠ¤í† ë¦¬ â”€â”€ */
function getHistory() {
  try { return JSON.parse(localStorage.getItem(HIST_KEY)) || []; } catch { return []; }
}
function addHistory(name) {
  let h = getHistory().filter(x => x !== name);
  h.unshift(name);
  localStorage.setItem(HIST_KEY, JSON.stringify(h.slice(0, 5)));
  renderHistory();
}
function clearHistory() {
  localStorage.removeItem(HIST_KEY);
  renderHistory();
  showToast('ê²€ìƒ‰ ê¸°ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
}
function renderHistory() {
  const h = getHistory();
  const row = document.getElementById('historyRow');
  if (!h.length) { row.classList.remove('show'); return; }
  row.classList.add('show');
  // ê¸°ì¡´ ì¹©ë§Œ ì œê±° (labelÂ·clear ë²„íŠ¼ ë³´ì¡´)
  row.querySelectorAll('.history-chip').forEach(el => el.remove());
  const clearBtn = document.getElementById('historyClearBtn');
  h.forEach(name => {
    const chip = document.createElement('button');
    chip.className = 'history-chip';
    chip.textContent = name; // â˜… textContent â€” XSS ì•ˆì „
    chip.setAttribute('aria-label', `${name} ë‹¤ì‹œ ë¶„ì„`);
    chip.addEventListener('click', () => {
      document.getElementById('productInput').value = name;
      runAnalysis();
    });
    row.insertBefore(chip, clearBtn);
  });
}
renderHistory();

/* â”€â”€ ì§„í–‰ë„ â”€â”€ */
function setProgress(p, msg) {
  // â˜… p=-1(ì—ëŸ¬)ì´ ì™€ë„ ì§„í–‰ë°” ì˜¤ì—¼ ë°©ì§€
  const safe = Math.max(0, Math.min(100, p));
  document.getElementById('progressBar').style.width = safe + '%';
  document.getElementById('pctText').textContent = safe + '%';
  document.getElementById('progressTrack').setAttribute('aria-valuenow', safe);
  if (msg) document.getElementById('statusMsg').textContent = msg;
}

/* â”€â”€ ì—ëŸ¬ â”€â”€ */
function showError(msg) {
  document.getElementById('errorMsg').textContent = msg;
  document.getElementById('errorCard').classList.add('show');
}
function hideError() { document.getElementById('errorCard').classList.remove('show'); }

/* â”€â”€ UI ë¦¬ì…‹ â”€â”€ */
function resetUI() {
  isAnalyzing = false;
  document.getElementById('analyzeBtn').disabled = false;
  document.getElementById('progressCard').classList.remove('show');
  document.getElementById('skeletonCard').classList.remove('show');
}

/* â˜… SSE ì •ë¦¬ (ì—°ê²° ëˆ„ìˆ˜ ë°©ì§€) */
function closeSSE() {
  if (_sse) { _sse.close(); _sse = null; }
  clearTimeout(_sseTimer);
  _sseTimer = null;
}

/* â”€â”€ ë¶„ì„ ì‹¤í–‰ â”€â”€ */
function runAnalysis() {
  const name = document.getElementById('productInput').value.trim();
  if (isAnalyzing) return;
  if (!validateInput(name)) return;

  closeSSE();
  hideError();
  hideInputError();
  isAnalyzing    = true;
  isEstimate     = false;
  currentProduct = name;
  retryCount     = 0;

  document.getElementById('analyzeBtn').disabled = true;
  document.getElementById('resultCard').classList.remove('show');
  document.getElementById('estimateBanner').classList.remove('show');
  document.getElementById('progressCard').classList.add('show');
  document.getElementById('skeletonCard').classList.add('show');
  setProgress(0, 'ë¶„ì„ ì¤€ë¹„ ì¤‘...');
  connectSSE(name);
}

function retryAnalysis() { hideError(); runAnalysis(); }

/* â”€â”€ SSE ì—°ê²° â”€â”€ */
function connectSSE(name) {
  // â˜… íƒ€ì„ì•„ì›ƒ: 2ë¶„ ë‚´ ì™„ë£Œ ì—†ìœ¼ë©´ ê°•ì œ ì¢…ë£Œ
  _sseTimer = setTimeout(() => {
    closeSSE();
    handleError('ì„œë²„ ì‘ë‹µ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤. (2ë¶„)', name);
  }, SSE_TIMEOUT);

  const src = new EventSource('/analyze?product=' + encodeURIComponent(name));
  _sse = src;

  src.onmessage = function(e) {
    let data;
    try { data = JSON.parse(e.data); } catch { return; }

    // ì§„í–‰ë„ (p >= 0 ì¼ ë•Œë§Œ ì—…ë°ì´íŠ¸)
    if (typeof data.p === 'number' && data.p >= 0) {
      setProgress(data.p, data.m);
    } else if (data.m) {
      document.getElementById('statusMsg').textContent = data.m;
    }

    // AI ì¶”ì • ê°ì§€
    if (data.m && data.m.includes('AI ì¶”ì •')) isEstimate = true;

    // ì™„ë£Œ
    if (data.p === 100 && data.answer) {
      clearTimeout(_sseTimer);
      src.close(); _sse = null;
      currentMarkdown = data.answer;
      addHistory(name);
      renderResult(name, data.answer, data.m || '');
      return;
    }

    // ì—ëŸ¬
    if (data.error) {
      clearTimeout(_sseTimer);
      src.close(); _sse = null;
      handleError(data.m || 'ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', name);
    }
  };

  // â˜… onerror: CLOSED ìƒíƒœëŠ” ë¬´ì‹œ (ì´ë¯¸ ì •ë¦¬ëœ ì—°ê²°)
  src.onerror = function() {
    if (src.readyState === EventSource.CLOSED) return;
    clearTimeout(_sseTimer);
    src.close(); _sse = null;
    handleError('ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', name);
  };
}

/* â”€â”€ ì—ëŸ¬ & ì§€ìˆ˜ ë°±ì˜¤í”„ ì¬ì‹œë„ â”€â”€ */
function handleError(msg, name) {
  if (retryCount < MAX_RETRY) {
    retryCount++;
    const delay = retryCount * 2000; // 2s â†’ 4s â†’ 6s
    document.getElementById('statusMsg').textContent =
      `ì¬ì—°ê²° ì¤‘... (${retryCount}/${MAX_RETRY}) â€” ${delay/1000}ì´ˆ í›„ ì¬ì‹œë„`;
    setTimeout(() => { if (isAnalyzing) connectSSE(name); }, delay);
  } else {
    resetUI();
    document.getElementById('skeletonCard').classList.remove('show');
    showError(msg + ` (ì¬ì‹œë„ ${MAX_RETRY}íšŒ ì‹¤íŒ¨)`);
  }
}

/* â”€â”€ ê²°ê³¼ ë Œë”ë§ â”€â”€ */
function renderResult(name, markdown, statusMsg) {
  setTimeout(() => {
    document.getElementById('skeletonCard').classList.remove('show');
    document.getElementById('progressCard').classList.remove('show');

    // â˜… DOMPurify ì •ì œ í›„ innerHTML
    document.getElementById('resultBody').innerHTML = safeMarkdown(markdown);

    // â˜… textContentë¡œ XSS ì•ˆì „í•˜ê²Œ ì œí’ˆëª… í‘œì‹œ
    document.getElementById('resultName').textContent = name;

    const est = isEstimate || statusMsg.includes('AI ì¶”ì •');
    if (est) {
      document.getElementById('resultDot').className = 'result-dot warn';
      document.getElementById('resultSub').textContent = 'AI ì¶”ì • ë¶„ì„ ì™„ë£Œ';
      document.getElementById('estimateBanner').classList.add('show');
    } else {
      document.getElementById('resultDot').className = 'result-dot';
      document.getElementById('resultSub').textContent = 'ë¦¬ë·° ê¸°ë°˜ ë¶„ì„ ì™„ë£Œ';
    }

    document.getElementById('resultCard').classList.add('show');
    document.getElementById('resultCard').scrollIntoView({ behavior: 'smooth', block: 'start' });
    resetUI();
  }, 500);
}

/* â”€â”€ ë³µì‚¬ (execCommand í´ë°± í¬í•¨) â”€â”€ */
function copyResult() {
  if (!currentMarkdown) return;
  if (!navigator.clipboard) {
    // HTTP í™˜ê²½ or êµ¬í˜• ë¸Œë¼ìš°ì € í´ë°±
    const ta = Object.assign(document.createElement('textarea'), {
      value: currentMarkdown, style: 'position:fixed;opacity:0'
    });
    document.body.appendChild(ta);
    ta.select();
    document.execCommand('copy');
    document.body.removeChild(ta);
    showToast('âœ“ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤');
    return;
  }
  navigator.clipboard.writeText(currentMarkdown)
    .then(() => showToast('âœ“ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤'))
    .catch(() => showToast('ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì§ì ‘ ì„ íƒí•´ ì£¼ì„¸ìš”.'));
}

/* â”€â”€ ë‹¤ìš´ë¡œë“œ (íŒŒì¼ëª… ìƒˆë‹ˆíƒ€ì´ì¦ˆ) â”€â”€ */
function downloadResult() {
  if (!currentMarkdown) return;
  try {
    const safe = currentProduct.replace(/[\\/:*?"<>|]/g, '_').slice(0, 50);
    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([currentMarkdown], { type: 'text/markdown;charset=utf-8' }));
    a.download = `${safe}_ë¶„ì„ë¦¬í¬íŠ¸.md`;
    a.click();
    URL.revokeObjectURL(a.href);
    showToast('â¬‡ íŒŒì¼ ì €ì¥ì„ ì‹œì‘í•©ë‹ˆë‹¤');
  } catch { showToast('íŒŒì¼ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'); }
}

/* â˜… í˜ì´ì§€ ì´íƒˆ ì‹œ SSE ì •ë¦¬ (ì—°ê²° ëˆ„ìˆ˜ ë°©ì§€) */
window.addEventListener('pagehide', closeSSE);
window.addEventListener('beforeunload', closeSSE);
</script>
</body>
</html>
