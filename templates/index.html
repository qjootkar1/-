<!DOCTYPE html>
<html lang="ko" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ì œí’ˆ ë¶„ì„ ë¦¬í¬íŠ¸</title>
    <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        :root {
            --bg: #f4f6fb;
            --card: #ffffff;
            --primary: #4f46e5;
            --text: #1f2937;
            --sub: #6b7280;
            --border: #e5e7eb;
            --shadow: 0 20px 50px rgba(0,0,0,0.08);
        }

        [data-theme="dark"] {
            --bg: #111827;
            --card: #1f2937;
            --text: #f9fafb;
            --sub: #9ca3af;
            --border: #374151;
            --shadow: 0 20px 50px rgba(0,0,0,0.4);
        }

        body {
            margin: 0;
            font-family: 'Pretendard', -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            transition: .3s;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 60px auto;
            padding: 40px;
            background: var(--card);
            border-radius: 24px;
            box-shadow: var(--shadow);
        }

        h1 { text-align: center; margin-bottom: 10px; color: var(--primary); }
        .sub-title { text-align: center; color: var(--sub); margin-bottom: 40px; }

        .input-wrap { display: flex; gap: 10px; margin-bottom: 30px; }
        input {
            flex: 1; padding: 16px; border-radius: 12px;
            border: 1px solid var(--border); font-size: 16px;
            background: var(--card); color: var(--text);
        }

        button {
            padding: 15px 30px; border: none; border-radius: 12px;
            background: var(--primary); color: white;
            font-weight: 600; cursor: pointer; transition: 0.2s;
        }
        button:disabled { background: var(--sub); opacity: 0.6; cursor: not-allowed; }

        /* ì§„í–‰ë°” ìŠ¤íƒ€ì¼ */
        .progress-wrapper { display: none; margin: 25px 0; }
        .progress-info { display: flex; justify-content: space-between; font-size: 14px; margin-bottom: 8px; }
        .progress-container { height: 8px; background: var(--border); border-radius: 4px; overflow: hidden; }
        .progress-bar { height: 100%; width: 0%; background: var(--primary); transition: .4s; }

        .result-area { margin-top: 40px; line-height: 1.8; border-top: 1px solid var(--border); padding-top: 20px; }
        
        /* ë§ˆí¬ë‹¤ìš´ ìŠ¤íƒ€ì¼ë§ */
        #result h2 { color: var(--primary); margin-top: 30px; border-left: 4px solid var(--primary); padding-left: 12px; }
        #result ul { padding-left: 20px; }
        #result strong { color: var(--primary); }

        .theme-toggle {
            position: fixed; top: 20px; right: 20px;
            padding: 10px; cursor: pointer; background: var(--card);
            border-radius: 50px; border: 1px solid var(--border);
            box-shadow: var(--shadow);
        }
    </style>
</head>
<body>

<div class="theme-toggle" onclick="toggleTheme()">ğŸŒ“ í…Œë§ˆ ì „í™˜</div>

<div class="container">
    <h1>AI ì œí’ˆ ë¶„ì„ ë¦¬í¬íŠ¸</h1>
    <p class="sub-title">ì‹¤ì œ ë¦¬ë·° ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ìƒì„±ëœ ì •ë°€ ë¦¬í¬íŠ¸</p>

    <div class="input-wrap">
        <input id="productName" placeholder="ì œí’ˆëª…ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ì•„ì´í° 16)">
        <button id="actionBtn" onclick="runAnalysis()">ë¶„ì„ ì‹œì‘</button>
    </div>

    <div id="progressArea" class="progress-wrapper">
        <div class="progress-info">
            <span id="statusMsg">ì¤€ë¹„ ì¤‘...</span>
            <span id="percentText">0%</span>
        </div>
        <div class="progress-container">
            <div class="progress-bar" id="bar"></div>
        </div>
    </div>

    <div id="result" class="result-area">ë¶„ì„ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
</div>

<script>
    // 1. í…Œë§ˆ ë³€ê²½ í•¨ìˆ˜
    function toggleTheme() {
        const html = document.documentElement;
        html.dataset.theme = html.dataset.theme === "dark" ? "light" : "dark";
    }

    let isAnalyzing = false;

    // 2. í•µì‹¬ ë¶„ì„ ì‹¤í–‰ í•¨ìˆ˜
    async function runAnalysis() {
        const name = document.getElementById("productName").value.trim();
        if (!name || isAnalyzing) return;

        // UI ìš”ì†Œ ì´ˆê¸°í™”
        const btn = document.getElementById("actionBtn");
        const progressArea = document.getElementById("progressArea");
        const bar = document.getElementById("bar");
        const percentText = document.getElementById("percentText");
        const statusMsg = document.getElementById("statusMsg");
        const resultDiv = document.getElementById("result");

        isAnalyzing = true;
        btn.disabled = true;
        progressArea.style.display = "block";
        resultDiv.style.opacity = "0.5";
        resultDiv.innerHTML = "ë¦¬í¬íŠ¸ë¥¼ ìƒì„± ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”...";

        // SSE ì—°ê²° (ë°±ì—”ë“œì™€ ì¼ì¹˜)
        const evtSource = new EventSource(`/analyze?product=${encodeURIComponent(name)}`);

        evtSource.onmessage = function(event) {
            const data = JSON.parse(event.data);

            // ì§„í–‰ë„ ë° ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
            if (data.p) {
                bar.style.width = data.p + "%";
                percentText.innerText = data.p + "%";
            }
            if (data.m) {
                statusMsg.innerText = data.m;
            }

            // ì™„ë£Œ ì‹œ ê²°ê³¼ ë Œë”ë§
            if (data.p === 100 && data.answer) {
                evtSource.close();
                setTimeout(() => {
                    progressArea.style.display = "none";
                    resultDiv.innerHTML = marked.parse(data.answer);
                    resultDiv.style.opacity = "1";
                    isAnalyzing = false;
                    btn.disabled = false;
                }, 500);
            }

            // ì˜¤ë¥˜ ë°œìƒ ì‹œ
            if (data.error) {
                evtSource.close();
                alert("ì˜¤ë¥˜ ë°œìƒ: " + data.m);
                resetUI();
            }
        };

        evtSource.onerror = function() {
            evtSource.close();
            alert("ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            resetUI();
        };

        function resetUI() {
            isAnalyzing = false;
            btn.disabled = false;
            progressArea.style.display = "none";
            resultDiv.style.opacity = "1";
        }
    }
</script>

</body>
</html>
